<html>
<head>
<title>Readability</title>
<style>
  body {
    padding: 0;
    margin: 0;
    font-family: sans-serif;
  }

  .readability {
    width: 600px;
    margin: 20px auto;
  }

  .readability__label {
    display: block;
    margin: 0 0 10px;
  }

  .readability__text {
    width: 584px;
    height: 150px;
    padding: 8px;
    margin: 0 0 20px;
    line-height: 24px;
    border: 1px solid #ddd;
    overflow-y: scroll;
  }

  .readability__complexword {
    padding: 2px;
    color: #d31145;
    background: #eee;
  }

  .readability__submit {
    float: right;
    display: block;
    border: 0;
    padding: 10px 20px;
    margin: 0 0 20px;
    background: #eee;
    color: #000;
    border: 1px solid #ddd;
    text-decoration: none;
  }

  .readability__cell {
    margin: 0 0 10px;
  }

  .bullet { width: 600px; height: 70px; margin: 20px auto; font: 11px sans-serif; }
  .bullet .tick line { stroke: #666; stroke-width: .5px; }
  .bullet .range.s0 { fill: #ddd; }
  .bullet .range.s1 { fill: #eee; }
  .bullet .range.s2 { fill: #ddd; }
  .bullet .range.s3 { fill: #eee; }
  .bullet .range.s4 { fill: #ddd; }
  .bullet .range.s0:hover,
  .bullet .range.s2:hover,
  .bullet .range.s4:hover { fill: #ccc; }
  .bullet .measure.s0 { fill: #d31145; }
  .bullet .measure.s1 { fill: #fb396d; }
  .bullet .title { font-size: 14px; font-weight: bold; }
  .bullet .subtitle { fill: #999; }

  .measure { pointer-events: none; }

  .tooltip { font-weight: bold; opacity: 0; }
  .bullet .range.s0:hover ~ .tooltip.t0,
  .bullet .range.s1:hover ~ .tooltip.t1,
  .bullet .range.s2:hover ~ .tooltip.t2,
  .bullet .range.s3:hover ~ .tooltip.t3,
  .bullet .range.s4:hover ~ .tooltip.t4 { opacity: 1; }
</style>
</head>
<body>
  <div class="readability">
    <form class="readability__form">
      <p class="readability__label">Enter text</p>
      <div class="readability__text" id="message" contenteditable></div>
      <a class="readability__submit" href="#">Run Test</a>
    </form>
    <div class="readability__graph"></div>
    <div class="readability__table"></div>
    <script id="readability__template" type="text/x-handlebars-template">
      <h3>Raw data from API</h3>
      <div class="readability__cell">Words</div>
      <div class="readability__cell">{{WORDS}}</div>
      <div class="readability__cell">Syllables</div>
      <div class="readability__cell">{{SYLLABLES}}</div>
      <div class="readability__cell">Coleman-Liau</div>
      <div class="readability__cell">{{COLEMAN_LIAU}}</div>
      <div class="readability__cell">Complex Word Count</div>
      <div class="readability__cell">{{COMPLEXWORDCOUNT}}</div>
      <div class="readability__cell">Complex Words</div>
      <div class="readability__cell">{{COMPLEXWORDS}}</div>
      <div class="readability__cell">Flesch-Kincaid</div>
      <div class="readability__cell">{{FLESCH_KINCAID}}</div>
      <div class="readability__cell">Flesch-Reading</div>
      <div class="readability__cell">{{FLESCH_READING}}</div>
      <div class="readability__cell">Gunning-Fog</div>
      <div class="readability__cell">{{GUNNING_FOG}}</div>
      <div class="readability__cell">Sentences</div>
      <div class="readability__cell">{{SENTENCES}}</div>
      <div class="readability__cell">Smog Index</div>
      <div class="readability__cell">{{SMOG_INDEX}}</div>
      <div class="readability__cell">Ari</div>
      <div class="readability__cell">{{ARI}}</div>
    </script>
  </div>
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="js/handlebars-v2.0.0.js"></script>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="js/textstatistics.js"></script>
  <script src="js/bullet.js"></script>
  <script src="js/d3.tip.js"></script>
  <script>
    var app = function ($) {

      var tooltip,
        readabilityText,
        $readabilityText = $('.readability__text');

      function init () {
        $('.readability__submit').on('click', function (e) {
          readabilityText = $readabilityText.text();

          e.preventDefault();

          if (readabilityText.length) {
            runTest(readabilityText);
          }
        });
      }

      function runTest (readabilityText) {
        var results = {},
          resultsComplex = {};

        results.WORDS = textstatistics().wordCount(readabilityText);
        results.SYLLABLES = textstatistics().syllableCount(readabilityText);
        results.SENTENCES = textstatistics().sentenceCount(readabilityText);
        results.FLESCH_KINCAID = textstatistics().fleschKincaidGradeLevel(readabilityText);
        results.FLESCH_READING = textstatistics().fleschKincaidReadingEase(readabilityText);
        results.COLEMAN_LIAU = textstatistics().colemanLiauIndex(readabilityText);
        results.GUNNING_FOG = textstatistics().gunningFogScore(readabilityText);
        results.SMOG_INDEX = textstatistics().smogIndex(readabilityText);
        resultsComplex = textstatistics().wordsWithThreeSyllables(readabilityText);
        results.COMPLEXWORDCOUNT = resultsComplex.longWordCount;
        results.COMPLEXWORDS = resultsComplex.longWords;
        results.ARI = textstatistics().automatedReadabilityIndex(readabilityText);

        showResults(results);
        /*return $.ajax({
          url: 'https://ipeirotis-readability-metrics.p.mashape.com/getReadabilityMetrics',
          type: 'POST',
          data: {
            text: text
          },
          datatype: 'json',
          success: function (results) {
            console.log(results);
            showResults(results);
          },
          error: function (err) {
            showError(err);
          },
          beforeSend: function (xhr) {
            xhr.setRequestHeader("X-Mashape-Authorization", "DIha08q5OnmshOi3CwTIT0Eo6tHfp1UvDD4jsnj2SKk0PGmcwF");
          }
        });*/
      }

      function showResults (results) {
        var source = $("#readability__template").html(),
            template = Handlebars.compile(source),
            fleschReading = [
              {
                "title": "Flesch Reading Ease",
                "subtitle": "Subtitle",
                "ranges": [30,60,70,90,100],
                "rangesLabels": ["Best understood by university graduates", "Easily understood by 13 to 15 year old students", "Easily understood by 13 to 15 year old students", "Easily understood by an average 11 year old student", "Easily understood by an average 11 year old student"],
                "measures": [results.FLESCH_READING],
                "markers": [100]
              }
            ];

        $(".readability__graph").empty();

        // Complex words
        if (results.COMPLEXWORDCOUNT > 0) {
          highlightComplexWords(readabilityText, results.COMPLEXWORDS);
        }
        
        // Chart
        var margin = {top: 0, right: 10, bottom: 0, left: 160},
            width = 600 - margin.left - margin.right,
            height = 30 - margin.top - margin.bottom;

        var chart = d3.bullet()
            .width(width)
            .height(height);

        var svg = d3.select(".readability__graph")
            .selectAll("svg")
            .data(fleschReading)
            .enter()
            .append("svg")
            .attr("class", "bullet")
          .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .call(chart);

        var title = svg.append("g")
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + height / 2 + ")");

        title.append("text")
            .attr("class", "title")
            .text(function(d) { return d.title; });

        title.append("text")
            .attr("class", "subtitle")
            .attr("dy", "1em")
            .text(function(d) { return d.subtitle; });

        // Results table
        return $('.readability__table').html(template(results));
      }

      function showError (err) {
        return $('.readability__table').html(err);
      }

      function highlightComplexWords (readabilityText, complexWords) {
        $.each(complexWords, function (i, v) {
          readabilityText = readabilityText.replace(complexWords[i], '<span class="readability__complexword">' + complexWords[i] + '</span>');
        });

        return $readabilityText.html(readabilityText);
      }

      return {
        init: init,
        runTest: runTest,
        showResults: showResults,
        highlightComplexWords: highlightComplexWords
      };

    }(jQuery);

    $(document).ready(function () {
      app.init();
    });
  </script>
</body>
</html>